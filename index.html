<!DOCTYPE html>
<html lang="si">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CWL Leaderboard - CHECKMATES</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: "Inter", sans-serif; margin:0; padding:20px; background: radial-gradient(circle at top, #2b1a08 0%, #120700 100%); color:#f9d37a; min-height:100vh; }
    .top-row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    h2.title{color:#ffcc33;margin:0;text-shadow:0 0 15px rgba(255,204,51,0.8);animation:titleGlow 3s infinite alternate;font-size:20px}
    @keyframes titleGlow{from{text-shadow:0 0 8px #ffb300}to{text-shadow:0 0 25px #ffe66d}}
    .subtitle{width:100%;text-align:center;color:#ffe28a;font-size:16px;margin:6px 0 18px;letter-spacing:1px;text-shadow:0 0 6px rgba(0,0,0,0.6)}
    .controls{display:flex;gap:8px;align-items:center}
    .arrow-btn{background:rgba(0,0,0,0.45);border:1px solid rgba(255,215,0,0.12);color:#fffbe0;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:0 2px 10px rgba(0,0,0,0.4)}
    .arrow-btn:active{transform:translateY(1px)}
    .month-select{background:rgba(0,0,0,0.35);color:#f9d37a;border:1px solid rgba(255,215,0,0.12);padding:8px 10px;border-radius:10px;font-weight:600}
    .table-container{overflow-x:auto;width:100%;background:rgba(0,0,0,0.55);border-radius:16px;box-shadow:0 0 25px rgba(255,204,51,0.25);padding:10px;backdrop-filter:blur(6px);margin-bottom:24px;animation:fadeIn 0.7s ease forwards}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    table{border-collapse:collapse;width:100%;border-radius:12px;overflow:hidden;background:linear-gradient(135deg,#3a250f,#6b3f11);color:#f9d37a;box-shadow:0 0 20px rgba(0,0,0,0.3);transition:transform .25s;font-size:15px}
    th{background:linear-gradient(90deg,#b8860b,#ffb300);color:#fffbe0;text-transform:uppercase;letter-spacing:0.5px;padding:10px;text-align:left;font-weight:600;position:sticky;top:0}
    td{border-bottom:1px solid rgba(255,255,255,0.06);padding:8px;text-align:left}
    tr:nth-child(even) td{background:rgba(255,255,255,0.02)}
    tr:hover td{background:rgba(255,204,51,0.06);color:#fff8e1}
    .small-muted{color:#f3e1b1;font-size:13px;opacity:0.9}
    .skeleton{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.06)); color:transparent}
    .error-box{background:rgba(0,0,0,0.6);border:1px solid rgba(255,50,50,0.12);padding:12px;border-radius:8px;color:#ffd7d7;margin-bottom:12px}
    @media(max-width:600px){table{font-size:13px}th,td{padding:6px}.arrow-btn{padding:6px 8px}h2.title{font-size:16px}.subtitle{font-size:13px}}
  </style>
</head>
<body>
  <div class="top-row">
    <h2 class="title" id="pageTitle">üèÜ CWL | Leaderboard - </h2>
    <div class="controls">
      <button id="prevBtn" class="arrow-btn" title="Previous month">‚óÄ</button>
      <select id="monthSelect" class="month-select" aria-label="Choose month"></select>
      <button id="nextBtn" class="arrow-btn" title="Next month">‚ñ∂</button>
    </div>
  </div>

  <div class="subtitle" id="subtitle">Season</div>

  <div id="errorArea"></div>

  <div class="table-container">
    <table id="dataTable" aria-live="polite"><tr><td class="skeleton">Loading...</td></tr></table>
  </div>

  <h2 class="title" style="margin-top:8px;">üèÅ Final Point Table</h2>
  <div class="table-container">
    <table id="finalTable" aria-live="polite"><tr><td class="skeleton">Loading...</td></tr></table>
  </div>

  <script>
    /**********************************************
     *  CONFIG - change these values if needed    *
     **********************************************/
    const spreadsheetId = "1AIy-9I3dWadyYZwvplNzU_onua60uWV_LG646JbY9yU";

    // Update months here. Using the gids you gave:
    const tables = {
      "November": { label: "November Season", gid: 0 },
      "December": { label: "December Season", gid: 1347643855 }
      "January": { label: "January Season", gid: 1272521645 }
      // Add more months like:
      // "January": { label: "January Season", gid: 22222222 },
      // Or use 'csv' property with full export link:
      // "January": { label: "January Season", csv: "https://docs.google.com/spreadsheets/d/.../export?format=csv&gid=..." }
    };

    const defaultMonth = "December";
    const REFRESH_INTERVAL = 30000; // ms

    /**********************************************
     *  Internal helpers and UI logic             *
     **********************************************/
    function buildCsvUrlFromGid(gid) {
      return `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&gid=${gid}`;
    }
    function getCsvUrl(entry) {
      if (!entry) return null;
      if (entry.csv) return entry.csv;
      if (typeof entry.gid !== "undefined" && entry.gid !== null) return buildCsvUrlFromGid(entry.gid);
      return `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv`;
    }

    function parseCsvLine(line) {
      const matches = line.match(/("([^"]*(?:""[^"]*)*)"|[^,]*)(,|$)/g);
      if (!matches) return [];
      return matches.map(m => {
        m = m.endsWith(',') ? m.slice(0,-1) : m;
        m = m.replace(/^"(.*)"$/, '$1').replace(/""/g, '"');
        return m.trim();
      });
    }

    const monthKeys = Object.keys(tables);
    const monthSelect = document.getElementById('monthSelect');
    monthKeys.forEach(k => {
      const opt = document.createElement('option');
      opt.value = k; opt.textContent = k;
      monthSelect.appendChild(opt);
    });

    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageTitle = document.getElementById('pageTitle');
    const subtitle = document.getElementById('subtitle');
    const dataTableEl = document.getElementById('dataTable');
    const finalTableEl = document.getElementById('finalTable');
    const errorArea = document.getElementById('errorArea');

    let currentIndex = Math.max(0, monthKeys.indexOf(defaultMonth));
    if (currentIndex < 0) currentIndex = 0;
    monthSelect.value = monthKeys[currentIndex];

    function showLoadingTables() {
      dataTableEl.innerHTML = "<tr><td class='skeleton'>Loading...</td></tr>";
      finalTableEl.innerHTML = "<tr><td class='skeleton'>Loading...</td></tr>";
      errorArea.innerHTML = "";
    }

    async function fetchWithTimeout(resource, options = {}) {
      const { timeout = 15000 } = options;
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      try {
        const response = await fetch(resource, { signal: controller.signal, cache: "no-store" });
        clearTimeout(id);
        return response;
      } catch (err) {
        clearTimeout(id);
        throw err;
      }
    }

    async function loadMonth(monthKey) {
      const entry = tables[monthKey];
      const csvUrl = getCsvUrl(entry);
      pageTitle.textContent = `üèÜ CWL | Leaderboard - ${entry?.label || monthKey}`;
      subtitle.textContent = entry?.label || monthKey;
      showLoadingTables();

      try {
        const resp = await fetchWithTimeout(csvUrl);
        if (!resp.ok) {
          // If receives 4xx/5xx try helpful error message & small fallback attempts
          const msg = `Sheet fetch failed: ${resp.status} ${resp.statusText}`;
          throw new Error(msg);
        }
        const text = await resp.text();
        const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
        if (lines.length === 0) {
          dataTableEl.innerHTML = "<tr><td>No data found</td></tr>";
          finalTableEl.innerHTML = "<tr><td>No data found</td></tr>";
          return;
        }

        const rows = lines.map(line => parseCsvLine(line));
        const headers = rows[0];
        const dataRows = rows.slice(1).filter(r => r.some(c => c.trim() !== ""));

        // sort by Rank if present
        const rankIndex = headers.findIndex(h => h && h.toLowerCase().trim() === "rank");
        if (rankIndex >= 0) dataRows.sort((a,b) => (parseFloat(a[rankIndex])||0) - (parseFloat(b[rankIndex])||0));

        // build main table
        let html = "<tr>";
        for (const h of headers) html += `<th>${h||""}</th>`;
        html += "</tr>";
        for (const row of dataRows) {
          html += "<tr>" + row.map(c => `<td>${c||""}</td>`).join("") + "</tr>";
        }
        dataTableEl.innerHTML = html;

        // build final points table (attempt)
        const playerIndex = headers.findIndex(h => h && h.toLowerCase().includes("player"));
        const pointsIndex = headers.findIndex(h => h && h.toLowerCase().includes("total points"));
        const destructionIndex = headers.findIndex(h => h && h.toLowerCase().includes("destruction"));
        let finalRows = dataRows;
        if (rankIndex >= 0) finalRows.sort((a,b) => (parseFloat(a[rankIndex])||0) - (parseFloat(b[rankIndex])||0));

        let finalHtml = "<tr><th>Player Name</th><th>Total Points</th><th>Destruction %</th><th>Rank</th></tr>";
        for (const r of finalRows) {
          finalHtml += `<tr>
            <td>${(playerIndex>=0 ? r[playerIndex] : r[0])||""}</td>
            <td>${(pointsIndex>=0 ? r[pointsIndex] : "")||""}</td>
            <td>${(destructionIndex>=0 ? r[destructionIndex] : "")||""}</td>
            <td>${(rankIndex>=0 ? r[rankIndex] : "")||""}</td>
          </tr>`;
        }
        finalTableEl.innerHTML = finalHtml;

      } catch (err) {
        console.error(err);
        // Friendly user message + troubleshooting hints
        const msg = (err && err.message) ? err.message : String(err);
        errorArea.innerHTML = `<div class="error-box">
          <strong>Data load failed:</strong> ${msg}<br>
          <small class="small-muted">Possible causes: sheet not shared as "Anyone with the link", wrong gid/csv, or Google blocking export. Verify the sheet's sharing settings and the gid value.</small>
        </div>`;

        dataTableEl.innerHTML = `<tr><td>Error loading sheet data<br><span class="small-muted">${msg}</span></td></tr>`;
        finalTableEl.innerHTML = `<tr><td>Error loading sheet data<br><span class="small-muted">${msg}</span></td></tr>`;
      }
    }

    function goToIndex(i) {
      if (i < 0) i = 0;
      if (i >= monthKeys.length) i = monthKeys.length - 1;
      currentIndex = i;
      monthSelect.value = monthKeys[currentIndex];
      loadMonth(monthKeys[currentIndex]);
    }

    prevBtn.addEventListener('click', () => goToIndex(currentIndex - 1));
    nextBtn.addEventListener('click', () => goToIndex(currentIndex + 1));
    monthSelect.addEventListener('change', (e) => {
      currentIndex = monthKeys.indexOf(e.target.value);
      loadMonth(monthKeys[currentIndex]);
    });

    // initial load
    goToIndex(currentIndex);

    // auto refresh
    setInterval(() => {
      loadMonth(monthKeys[currentIndex]);
    }, REFRESH_INTERVAL);

    /**********************************************
     *  Quick tips (‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω‡∑ô‡∂±‡∑ä)                   *
     *  - If "Data load failed" appears:         *
     *    1) Open the Google Sheet ‚Üí Share ‚Üí      *
     *       Change General access to "Anyone    *
     *       with the link" (Viewer).            *
     *    2) If November returns gid=0 and still *
     *       fails, try duplicating that sheet   *
     *       (Right-click tab ‚Üí Duplicate) and   *
     *       use the new tab's gid here.         *
     *  - To add months: edit the `tables` obj   *
     **********************************************/
  </script>
      
</body>
</html>
